# 表情回复功能权限配置说明

## 🔍 问题诊断结果

通过调试发现，表情回复事件中的 `event.user_id` 字段返回 `None`，这是因为**缺少必要的权限配置**。

## ⚠️ 根本原因

`user_id` 是飞书 API 中的**敏感字段**，需要额外申请权限才能获取。

## 📋 需要配置的权限

要让表情回复功能正常工作，需要在飞书开放平台配置以下权限：

### 1. 事件订阅

进入你的应用 → **事件订阅** → 添加事件：
- ✅ `im.message.reaction.created_v1` - 消息表情回复创建

### 2. 权限范围（Scopes）

进入你的应用 → **权限管理** → 添加权限：
- ✅ **获取单聊、群组消息** (im:message)
- ✅ **获取与发送单聊、群组消息** (im:message:send_as_bot)

### 3. 字段权限（敏感字段）⭐ **关键**

这是最容易被忽略的配置！

进入你的应用 → **权限管理** → **字段权限** → 申请以下权限：
- ✅ **获取用户 user ID** (contact:user.user_id:readonly)

> **重要提示**：如果不申请这个字段权限，`event.user_id` 将始终返回 `None`！

## 🔧 配置步骤

### 步骤 1：进入飞书开放平台

1. 访问：https://open.feishu.cn/
2. 登录并进入你的应用管理后台

### 步骤 2：配置事件订阅

1. 点击左侧菜单 **"事件订阅"**
2. 点击 **"添加事件"**
3. 搜索 `im.message.reaction.created_v1`
4. 点击 **"添加"** 按钮
5. 保存配置

### 步骤 3：配置权限范围

1. 点击左侧菜单 **"权限管理"**
2. 在搜索框中搜索 **"消息"**
3. 勾选以下权限：
   - 获取单聊、群组消息
   - 获取与发送单聊、群组消息
4. 点击 **"保存"**

### 步骤 4：申请字段权限 ⭐ **最关键**

1. 在 **"权限管理"** 页面
2. 找到 **"字段权限"** 或 **"敏感字段权限"** 标签
3. 搜索 **"user ID"** 或 **"用户ID"**
4. 申请 **"获取用户 user ID"** 权限
5. 提交申请并等待审核（通常很快）

### 步骤 5：重新安装应用

权限配置完成后，需要重新安装应用：
1. 进入应用管理后台
2. 点击 **"版本管理与发布"**
3. 如果是测试应用，点击 **"创建版本"** 并发布
4. 在群里重新添加机器人（或刷新权限）

## 🧪 验证配置

配置完成后，重启监听程序并测试：

```bash
python long_connection_listener.py
```

然后在群里给任意消息添加表情回复，观察日志：

### 成功的日志示例：
```
[V3-LOG] [18:55:00] 收到表情回复事件===================
  > 消息ID: om_xxx
  > 操作者ID: ou_xxx
  > 点赞者: 张三
  > 被点赞者: 李四
✅ 表情回复统计成功
```

### 失败的日志示例（权限不足）：
```
[V3-LOG] [18:55:00] 收到表情回复事件===================
  > 消息ID: om_xxx
  > [警告] event.user_id 为 None
  > [提示] 需要在飞书开放平台申请以下权限：
  >   1. 订阅事件: im.message.reaction.created_v1
  >   2. 权限范围: 获取单聊、群组消息
  >   3. 字段权限: 获取用户 user ID (敏感字段)
```

## 📊 替代方案

如果无法获得字段权限（例如企业管理员不批准），可以考虑以下替代方案：

### 方案 1：移除表情回复功能

专注于已经正常工作的功能：
- ✅ 发言次数
- ✅ 发言字数
- ✅ 被回复数
- ✅ 被@次数
- ✅ 发起话题数

这些指标已经足够全面地反映用户活跃度。

### 方案 2：使用消息 ID 关联

虽然无法直接获取点赞者信息，但可以统计：
- 每条消息被点赞的总次数
- 用户发送的消息被点赞的总数

这需要修改统计逻辑，不再区分"点赞数"和"被点赞数"，只统计"被点赞数"。

## 💡 建议

1. **优先尝试申请字段权限**：这是最直接的解决方案
2. **如果权限申请被拒**：考虑移除表情回复功能
3. **专注核心功能**：确保消息监听等核心功能稳定运行

## 🔗 相关文档

- [飞书开放平台 - 权限管理](https://open.feishu.cn/document/home/introduction-to-scope-and-authorization/scope-introduction)
- [飞书开放平台 - 敏感字段权限](https://open.feishu.cn/document/ukTMukTMukTM/uQjN3QjL0YzN04CN2cDN)
- [表情回复事件文档](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/im-v1/message-reaction/events/created)

## ❓ 常见问题

**Q: 为什么 `open_id` 也获取不到？**
A: 因为整个 `user_id` 对象都是 `None`，所以无法访问其中的任何字段（包括 `open_id`）。必须先申请字段权限。

**Q: 字段权限申请需要多久？**
A: 通常几分钟到几小时，取决于企业管理员的审核速度。

**Q: 如果是个人开发者，能申请到这个权限吗？**
A: 可以，个人开发者创建的自建应用通常可以直接获得这个权限。

**Q: 配置完权限后还是不行怎么办？**
A: 确保重新安装了应用，并且机器人在群里有足够的权限。
