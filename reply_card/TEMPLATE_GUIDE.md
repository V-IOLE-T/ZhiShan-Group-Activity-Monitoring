# 使用卡片模板发送文档摘要

## 功能说明

机器人现在支持两种卡片发送模式：

### 模式 1：模板模式（推荐）
使用飞书卡片搭建工具创建的卡片模板，支持：
- ✅ 可视化设计卡片样式
- ✅ 动态变量填充
- ✅ 版本管理
- ✅ 更新模板后自动生效

### 模式 2：JSON 模式（默认）
直接通过代码构建卡片 JSON，适合快速开发和调试。

---

## 配置步骤

### 第一步：创建卡片模板

1. 访问 [飞书卡片搭建工具](https://open.feishu.cn/cardkit)
2. 点击 **+ 创建空白卡片**
3. 选择 **新版卡片**

### 第二步：设计卡片样式

参考以下设计建议：

```
┌─────────────────────────────────┐
│ 📄 已为您提取文档内容           │  ← 标题
├─────────────────────────────────┤
│                                 │
│ 文档预览：                      │
│ ${doc_preview}                  │  ← 变量：文档前300字
│                                 │
├─────────────────────────────────┤
│ [查看文档详情] ← 按钮            │
└─────────────────────────────────┘
```

### 第三步：配置卡片变量

在搭建工具中添加以下变量：

| 变量名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `doc_preview` | 文本 | 文档预览内容（前300字） | "这是一篇关于..." |
| `doc_url` | 链接 | 文档完整链接 | https://xxx.feishu.cn/docx/xxx |

**操作方法：**
1. 在卡片编辑器中，选中文本组件
2. 点击右侧 **内容** → **绑定变量**
3. 输入变量名：`doc_preview`
4. 在 **模拟数据** 中填写测试值

### 第四步：添加应用权限

1. 在卡片编辑器顶部，点击 **应用图标**
2. 选择 **添加应用**
3. 选择你的机器人应用（APP_ID: `cli_a9ed94418c785cbd`）
4. 点击 **确定**

### 第五步：发布卡片

1. 点击右上角 **保存**
2. 点击 **向我发送预览** 测试效果
3. 确认无误后，点击 **发布**
4. 设置版本号（首次发布建议 `1.0.0`）
5. 记录下以下信息：
   - **卡片模板 ID**（template_id）：在卡片列表中复制
   - **版本号**（template_version_name）：例如 `1.0.0`

### 第六步：配置代码

打开 `reply_card/card_builder.py`，修改以下配置：

```python
class CardBuilder:
    # 配置：卡片模板信息（请在搭建工具中创建后填写）
    TEMPLATE_ID = "AAqyjwfhabcef"  # ← 填写你的模板 ID
    TEMPLATE_VERSION = "1.0.0"      # ← 填写版本号
    USE_TEMPLATE = True             # ← 改为 True 启用模板模式
```

### 第七步：重启机器人

```bash
# Ctrl+C 停止当前运行
python long_connection_listener.py
```

---

## 测试验证

1. 给机器人发送一个文档链接
2. 检查收到的卡片是否使用了你设计的模板样式
3. 确认文档预览内容正确显示（前300字）

---

## 变量说明

代码会自动填充以下变量：

| 变量名 | 数据来源 | 处理逻辑 |
|--------|----------|----------|
| `doc_preview` | MCP 获取的文档内容 | 提取纯文本，截取前 300 字 |
| `doc_url` | 文档链接 | 根据 doc_token 构建完整链接 |

---

## 常见问题

### Q1: 卡片没有使用模板样式？
**A:** 检查以下配置：
- `USE_TEMPLATE` 是否设置为 `True`
- `TEMPLATE_ID` 是否正确填写
- 卡片是否已发布
- 应用是否已添加到卡片权限中

### Q2: 提示权限不足？
**A:** 确保：
- 在搭建工具中已将应用添加到卡片
- 应用已开通 `im:message:send_as_bot` 权限

### Q3: 变量没有显示内容？
**A:** 检查：
- 变量名是否与代码中一致（`doc_preview`、`doc_url`）
- 在搭建工具中是否正确绑定了变量

### Q4: 想要修改预览字数？
**A:** 修改 `card_builder.py` 中的这一行：
```python
preview_text = full_text[:300]  # 改为你想要的字数
```

---

## 切换回 JSON 模式

如果想临时使用 JSON 模式（不使用模板）：

```python
USE_TEMPLATE = False  # 改为 False
```

JSON 模式的卡片样式在 `_build_json_card` 方法中定义，可以直接修改代码调整样式。

---

## 高级用法

### 动态选择模板

你可以根据不同文档类型使用不同模板：

```python
# 在 build_doc_card 方法中
if "wiki" in doc_token:
    TEMPLATE_ID = "wiki_template_id"
elif "docx" in doc_token:
    TEMPLATE_ID = "docx_template_id"
```

### 添加更多变量

在搭建工具中添加新变量后，在代码中填充：

```python
"template_variable": {
    "doc_preview": preview_text,
    "doc_url": doc_url,
    "doc_title": "文档标题",  # 新增
    "author": "作者名",        # 新增
}
```
