# 单聊文档提取功能排查指南

## 问题：发送消息后没有任何反应

### 根本原因
程序没有收到消息事件，这是**权限配置**问题。

### 解决步骤

#### 1. 检查应用权限（最关键）

前往 [飞书开放平台](https://open.feishu.cn/app) → 你的应用 → **权限管理**

**必须开通以下权限：**

| 权限名称 | 权限代码 | 用途 |
|---------|---------|------|
| 获取与发送单聊、群组消息 | `im:message` | 接收单聊消息 |
| 接收消息 v2.0 | `im:message:receive_v1` | 监听消息事件 |
| 以应用身份读取消息 | `im:message:readonly` | 读取消息内容 |
| 以应用身份发送消息 | `im:message:send_as_bot` | 回复消息 |
| 查看新版文档 | `docx:document:readonly` | MCP 获取文档内容 |

#### 2. 订阅消息事件

前往 **事件订阅** → **添加事件**

**必须订阅：**
- ✅ `接收消息 v2.0` (im.message.receive_v1)

#### 3. 配置事件回调

有两种方式：

**方式 A：长连接模式（推荐，你当前使用的）**
- 不需要配置请求网址
- 程序通过 WebSocket 自动接收事件

**方式 B：Webhook 模式**
- 需要公网 IP 和回调 URL
- 需要在"事件订阅"中配置请求网址

#### 4. 应用版本发布

⚠️ **关键步骤**：修改权限后必须：
1. 点击右上角 **创建版本**
2. 填写版本说明
3. 点击 **申请发布**
4. 等待审核通过（企业内部应用通常秒过）

**如果不发布新版本，权限不会生效！**

#### 5. 用户添加机器人

确保你已经：
- ✅ 在飞书中搜索并添加了这个机器人为好友
- ✅ 或者在某个群里添加了机器人

#### 6. 验证配置

发送测试消息后，检查终端日志：

**正常情况：**
```
[V3-LOG] [00:43:58] 收到新消息=========================
  > [调试] chat_type=p2p, is_p2p=True, is_target_group=False
  > [单聊] 检测到单聊消息，开始处理文档提取...
```

**异常情况（无任何输出）：**
- 说明程序没有收到事件 → 检查上述 1-5 步

### 快速自查清单

- [ ] 权限已开通（im:message, im:message:receive_v1, im:message:send_as_bot, docx:document:readonly）
- [ ] 事件已订阅（im.message.receive_v1）
- [ ] 应用版本已发布
- [ ] 已添加机器人为好友
- [ ] 程序正常启动（看到 "🚀 飞书实时监听 [V3-STABLE] 启动"）
- [ ] .env 文件中 APP_ID 和 APP_SECRET 正确

### 常见错误

**错误 1：权限开通了但没发布版本**
- 解决：创建版本 → 申请发布

**错误 2：只订阅了事件，没开通权限**
- 解决：权限管理中开通对应权限

**错误 3：使用了旧版本的机器人**
- 解决：删除旧机器人，重新添加

**错误 4：APP_ID 或 APP_SECRET 错误**
- 解决：从开放平台复制最新的凭证到 .env

### 测试建议

1. **先测试群消息**：在配置的目标群里发消息，看是否有日志输出
2. **再测试单聊**：确认程序能接收事件后，再测试单聊功能
3. **使用简单文本**：先发 "测试"，确认能收到消息
4. **再发文档链接**：确认链接识别和 MCP 调用

### 仍然无法解决？

检查飞书开放平台的 **事件日志**：
- 开放平台 → 你的应用 → 事件与回调 → 事件日志
- 查看是否有推送失败的记录
