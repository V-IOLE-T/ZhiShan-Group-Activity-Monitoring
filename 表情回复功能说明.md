# 表情回复（点赞）监听功能说明

## ✅ 已完成的功能

### 📊 新增统计指标

在原有的消息统计基础上，新增了以下两个指标：

1. **点赞数**：用户主动给别人点赞的次数
2. **被点赞数**：用户的消息被别人点赞的次数

### 🎯 工作原理

当用户在群聊中给消息添加表情回复（点赞）时：

1. **点赞者**的"点赞数" +1
2. **被点赞者**（消息发送者）的"被点赞数" +1
3. 两个指标都会实时更新到多维表格
4. 自动更新活跃度分数

### 📈 活跃度分数计算

新的活跃度分数计算公式：

```
活跃度分数 = 
    发言次数 × 2.0 +
    发言字数 × 0.01 +
    被回复数 × 1.5 +
    单独被@次数 × 1.5 +
    发起话题数 × 1.5 +
    点赞数 × 1.0 +        ← 新增
    被点赞数 × 1.0        ← 新增
```

## 📋 需要添加的表格字段

请在飞书多维表格中添加以下两个新字段：

| 字段名 | 字段类型 | 说明 |
|--------|----------|------|
| 点赞数 | 数字 | 用户主动点赞的次数 |
| 被点赞数 | 数字 | 用户被点赞的次数 |

### 操作步骤

1. 打开飞书多维表格
2. 点击右侧的 **"+"** 添加新列
3. 字段名：`点赞数`，类型：**数字**
4. 再次点击 **"+"** 添加新列
5. 字段名：`被点赞数`，类型：**数字**

## 🔧 需要配置的权限

在飞书开放平台的应用管理中，确保已订阅以下事件：

1. ✅ `im.message.receive_v1` - 接收消息（已有）
2. ✅ `im.message.reaction.created_v1` - 表情回复创建（新增）

### 订阅步骤

1. 进入飞书开放平台 → 你的应用
2. 点击"事件订阅"
3. 搜索 `im.message.reaction.created_v1`
4. 点击"订阅"按钮
5. 保存配置

## 🧪 测试功能

### 1. 检查字段配置

运行以下命令检查所有字段是否正确配置：

```bash
python check_table_fields.py
```

### 2. 启动监听程序

```bash
python long_connection_listener.py
```

### 3. 测试点赞功能

1. 在群里发一条消息
2. 给这条消息添加表情回复（点赞）
3. 观察程序日志，应该看到类似输出：

```
[V3-LOG] [18:30:00] 收到表情回复事件===================
  > 消息ID: om_xxx
  > 操作者ID: ou_xxx
  > 点赞者: 张三
  > 被点赞者: 李四
  > [API] ✅ 找到已存在的记录
  > [API] 正在更新记录 xxx...
  > [API] ✅ 更新成功
  > [API] ✅ 找到已存在的记录
  > [API] 正在更新记录 xxx...
  > [API] ✅ 更新成功
✅ 表情回复统计成功
```

4. 检查多维表格，应该看到：
   - 点赞者的"点赞数" +1
   - 被点赞者的"被点赞数" +1
   - 两人的"活跃度分数"都有更新

## 📊 完整字段列表

更新后，你的多维表格应该包含以下字段：

| 字段名 | 字段类型 | 说明 |
|--------|----------|------|
| 用户ID | 文本 | 用户的 open_id |
| 用户名称 | 文本 | 用户的群昵称 |
| 人员 | 人员 | 关联飞书账号 |
| 统计周期 | 文本 | 格式：YYYY-MM |
| 更新时间 | 数字 | 时间戳（毫秒） |
| 发言次数 | 数字 | 发送消息数量 |
| 发言字数 | 数字 | 发送文字总数 |
| 被回复数 | 数字 | 被回复次数 |
| 单独被@次数 | 数字 | 被 @ 次数 |
| 发起话题数 | 数字 | 发起话题数量 |
| **点赞数** | **数字** | **主动点赞次数（新增）** |
| **被点赞数** | **数字** | **被点赞次数（新增）** |
| 活跃度分数 | 数字 | 综合活跃度分数 |

## ⚠️ 注意事项

1. **自己给自己点赞不计入统计**：程序会自动跳过用户给自己的消息点赞的情况
2. **事件去重**：程序会自动去重，避免重复统计
3. **实时更新**：点赞事件会实时更新到表格，无需等待定时任务
4. **所有表情都统计**：无论是什么表情（👍、❤️、😄等），都会计入点赞数

## 🚀 版本信息

- **版本**：V4-REACTION
- **新增功能**：表情回复（点赞）监听
- **兼容性**：完全兼容之前的消息监听功能
