# Pin消息归档表 - 字段格式示例

## 时间字段格式说明

### 存储格式

所有时间字段(Pin时间、消息发送时间、归档时间)都使用 **Unix时间戳(毫秒)** 格式:

- **数据类型**: 数字(整数)
- **小数位数**: 0 (不保留小数)
- **位数**: 13位整数
- **示例值**: `1736935230000`

### 在Bitable中的显示

#### 方式1: 直接显示数字(默认)

如果字段类型设置为"数字",会直接显示:
```
1736935230000
```

#### 方式2: 转换为日期时间显示(推荐)

在Bitable中,可以将数字字段的显示格式设置为"日期时间":

1. 点击字段设置
2. 选择"数字格式" → "日期时间"
3. 自动转换显示为: `2026-01-15 18:20:30`

### 实际数据示例

假设在 `2026-01-15 18:20:30` 这个时刻Pin了一条消息,归档表中的数据如下:

| 字段名 | 存储值 | Bitable显示(日期时间格式) |
|-------|--------|------------------------|
| Pin时间 | `1736935230000` | `2026-01-15 18:20:30` |
| 消息发送时间 | `1736935100000` | `2026-01-15 18:18:20` |
| 归档时间 | `1736935235000` | `2026-01-15 18:20:35` |

### 时间戳转换

#### Python代码转换
```python
import time
from datetime import datetime

# 毫秒时间戳转日期时间
timestamp_ms = 1736935230000
dt = datetime.fromtimestamp(timestamp_ms / 1000)
print(dt.strftime("%Y-%m-%d %H:%M:%S"))
# 输出: 2026-01-15 18:20:30

# 日期时间转毫秒时间戳
dt = datetime(2026, 1, 15, 18, 20, 30)
timestamp_ms = int(dt.timestamp() * 1000)
print(timestamp_ms)
# 输出: 1736935230000
```

#### 在线转换工具
- https://tool.lu/timestamp/
- 输入 `1736935230000` (注意选择"毫秒")
- 输出: `2026-01-15 18:20:30`

## 完整记录示例

### 示例1: 文本消息被Pin

```json
{
  "Pin消息ID": "om_abc123def456",
  "消息内容": "这是一条重要的通知,请大家注意查看附件中的详细说明。",
  "消息类型": "text",
  "发送者ID": "ou_user123",
  "发送者姓名": "张三",
  "Pin操作人ID": "ou_admin456",
  "Pin操作人姓名": "李四(管理员)",
  "Pin时间": 1736935230000,
  "消息发送时间": 1736935100000,
  "消息链接": "https://applink.feishu.cn/client/chat/open?openId=oc_xxxxx",
  "归档时间": 1736935235000
}
```

**Bitable显示效果**(设置日期时间格式后):
- Pin时间: `2026-01-15 18:20:30`
- 消息发送时间: `2026-01-15 18:18:20`
- 归档时间: `2026-01-15 18:20:35`

### 示例2: 富文本消息被Pin

```json
{
  "Pin消息ID": "om_xyz789ghi012",
  "消息内容": "项目进度更新\n\n本周完成情况:\n1. 完成了用户认证模块\n2. 优化了数据库查询性能\n3. 修复了3个已知bug\n\n下周计划:\n1. 开发消息推送功能\n2. 进行压力测试",
  "消息类型": "post",
  "发送者ID": "ou_user789",
  "发送者姓名": "王五",
  "Pin操作人ID": "ou_admin456",
  "Pin操作人姓名": "李四(管理员)",
  "Pin时间": 1736936400000,
  "消息发送时间": 1736936200000,
  "消息链接": "https://applink.feishu.cn/client/chat/open?openId=oc_xxxxx",
  "归档时间": 1736936405000
}
```

**说明**: 
- 富文本消息的所有段落都会被完整提取
- 段落之间用换行符(`\n`)分隔
- 在Bitable的"多行文本"字段中会正确显示换行

### 示例3: 图片消息被Pin

```json
{
  "Pin消息ID": "om_img123abc456",
  "消息内容": "[图片]",
  "消息类型": "image",
  "发送者ID": "ou_user456",
  "发送者姓名": "赵六",
  "Pin操作人ID": "ou_admin789",
  "Pin操作人姓名": "孙七(管理员)",
  "Pin时间": 1736937600000,
  "消息发送时间": 1736937500000,
  "消息链接": "https://applink.feishu.cn/client/chat/open?openId=oc_xxxxx",
  "归档时间": 1736937605000
}
```

## 常见问题

### Q1: 为什么时间是13位数字?

**A**: 这是Unix时间戳的毫秒格式:
- 秒级时间戳: 10位数字 (例: `1736935230`)
- 毫秒级时间戳: 13位数字 (例: `1736935230000`)
- 飞书API返回的时间都是毫秒级,所以我们也使用毫秒级存储

### Q2: 可以改成秒级时间戳吗?

**A**: 可以,但不推荐。如果要改:
1. 修改 `storage.py` 中的时间字段,除以1000
2. 但这样会丢失毫秒精度,且与飞书API格式不一致

### Q3: Bitable中时间显示不正确怎么办?

**A**: 检查以下几点:
1. 字段类型是否为"数字"
2. 数字格式是否设置为"日期时间"
3. 时区设置是否正确(应该是 UTC+8 北京时间)

### Q4: 消息内容太长会被截断吗?

**A**: 不会。代码已经修改为提取完整内容:
- 文本消息: 完整提取所有文本
- 富文本消息: 提取所有段落,用换行符分隔
- 图片/文件: 显示 `[图片]` 或 `[文件]`

### Q5: 如何在Excel中查看时间?

**A**: 如果导出到Excel:
1. 时间戳列会显示为数字
2. 使用公式转换: `=(A1/1000-8*3600)/86400+70*365+19`
3. 或者在Bitable中先设置好日期时间格式再导出

## 技术细节

### 时间戳生成代码

在 `storage.py` 的 `archive_pin_message` 方法中:

```python
fields = {
    "Pin时间": int(pin_info.get("pin_time", 0)),           # 飞书API返回的毫秒时间戳
    "消息发送时间": int(pin_info.get("create_time", 0)),   # 飞书API返回的毫秒时间戳
    "归档时间": int(time.time() * 1000)                    # 当前时间转毫秒时间戳
}
```

### 精度说明

- **Pin时间**: 由飞书API提供,精确到毫秒
- **消息发送时间**: 由飞书API提供,精确到毫秒
- **归档时间**: 由Python `time.time()` 生成,精确到毫秒

所有时间都使用 `int()` 转换为整数,确保不会有小数。
