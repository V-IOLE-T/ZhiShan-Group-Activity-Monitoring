# 消息和话题链接功能说明

## 功能概述
为消息归档表和话题汇总表添加了可点击的链接字段，用户可以通过链接直接跳转到飞书客户端查看对应的消息或话题。

## 新增字段

### 1. 消息归档表
- **字段名**: `消息链接`
- **字段类型**: URL（超链接）
- **格式**: 
  ```json
  {
    "link": "https://applink.feishu.cn/client/chat/open?openChatId={CHAT_ID}&messageId={message_id}",
    "text": "查看消息"
  }
  ```
- **说明**: 点击链接可直接在飞书客户端中打开对应消息

### 2. 话题汇总表  
- **字段名**: `话题链接`
- **字段类型**: URL（超链接）
- **格式**: 
  ```json
  {
    "link": "https://applink.feishu.cn/client/chat/open?openChatId={CHAT_ID}&messageId={root_id}",
    "text": "查看话题"
  }
  ```
- **说明**: 点击链接可直接在飞书客户端中打开话题的首条消息（即话题的起始位置）


## 链接格式说明

使用的是飞书客户端深链接（App Link）格式，具有以下特点：

1. **自动打开客户端**: 点击链接会自动唤起飞书客户端（如已安装）
2. **精准定位**: 直接跳转到指定的群聊和消息位置
3. **跨平台支持**: 支持桌面端和移动端

## 链接参数

- `openChatId`: 群聊 ID，从环境变量 `CHAT_ID` 获取
- `messageId`: 消息 ID
  - 对于消息归档表：使用当前消息的 ID
  - 对于话题汇总表：使用话题的根消息 ID（root_id）

## 使用场景

1. **快速查看上下文**: 在多维表格中查看归档消息时，点击链接可快速跳转到飞书查看完整对话上下文
2. **话题追踪**: 在话题汇总表中点击话题链接，可以快速查看整个话题的讨论内容
3. **数据审核**: 方便管理员审核归档的数据是否正确

## 注意事项

1. 链接需要在已登录飞书的设备上才能正常打开
2. 用户需要有该群聊的访问权限
3. 如果消息已被删除，链接可能无法正常打开
4. 首次使用时，浏览器可能会提示是否允许打开飞书客户端

## 代码位置

修改的文件：`long_connection_listener.py`

- **第 199-204 行**: 构建消息链接（对象格式）
- **第 217 行**: 将消息链接添加到归档字段
- **第 235-240 行**: 构建话题链接（对象格式）
- **第 256 行**: 将话题链接添加到话题汇总字段

## 重要说明

**URL 字段格式要求**：飞书多维表格的 URL 字段必须使用对象格式，而不是简单的字符串。对象包含两个属性：
- `link`: 实际的 URL 地址
- `text`: 显示文本（可选，但建议提供）

这是飞书 API 的要求，如果只传递字符串会导致 `URLFieldConvFail` 错误。

## 更新时间

2026-01-15
