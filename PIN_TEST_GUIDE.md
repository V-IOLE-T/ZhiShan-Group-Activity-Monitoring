# Pin消息监控功能 - 快速测试指南

## 修复说明

已修复API参数错误:
- ❌ 之前: `container_id` + `container_id_type`
- ✅ 现在: `chat_id`

## 测试步骤

### 1. 确认权限配置

在飞书开放平台确认已添加以下权限:
- ✅ `im:message.pins:read` - 查看Pin消息
- ✅ `im:message:readonly` - 获取消息内容
- ✅ `im:message` - 发送提醒消息
- ✅ `bitable:app` - 写入归档表

### 2. 创建Bitable表

创建"Pin消息归档表",包含以下字段:

| 字段名 | 字段类型 |
|-------|---------|
| Pin消息ID | 文本 |
| 消息内容 | 多行文本 |
| 消息类型 | 单选 |
| 发送者ID | 文本 |
| 发送者姓名 | 文本 |
| Pin操作人ID | 文本 |
| Pin操作人姓名 | 文本 |
| Pin时间 | 文本 |
| 消息发送时间 | 文本 |
| 消息链接 | URL |
| 归档时间 | 文本 |
| 附件信息 | 附件 |

### 3. 配置环境变量

编辑 `.env` 文件:
```bash
PIN_TABLE_ID=tblxxxxxxxxxx  # Pin消息归档表ID
PIN_MONITOR_INTERVAL=30     # 轮询间隔(秒)
```

### 4. 运行程序

```bash
python long_connection_listener.py
```

### 5. 测试功能

#### 测试1: 新增Pin消息

**操作**: 在群内Pin一条消息

**预期日志**:
```
[Pin监控] 当前群内Pin消息数量: 1
[Pin监控] 发现新Pin消息: om_xxx
[Pin监控] 消息发送者: 张三, Pin操作人: 李四
[Pin监控] ✅ 发送提醒卡片成功
[Pin归档] ✅ Pin消息已归档到Bitable
[Pin统计] ✅ 张三 被Pin次数: 0 -> 1
```

**预期效果**:
- ✅ 群内收到消息卡片提醒
- ✅ Pin归档表新增一条记录
- ✅ 活跃度表中"被Pin次数"+1

#### 测试2: Pin富文本消息

**操作**: Pin一条包含多段文字的富文本消息

**预期效果**:
- ✅ 消息内容字段显示纯文本,保留换行
- ✅ 例如:
  ```
  项目进度更新
  
  本周完成:
  1. 功能A
  2. 功能B
  ```

#### 测试3: Pin图片消息

**操作**: Pin一条图片消息

**预期日志**:
```
[Pin监控] 发现新Pin消息: om_xxx
  > [Pin附件] 正在处理图片消息: img_xxx
  > [Pin附件] ✅ 附件已上传: file_token_xxx
[Pin归档] ✅ Pin消息已归档到Bitable
```

**预期效果**:
- ✅ 消息内容显示: `[图片]`
- ✅ 附件信息字段包含图片

#### 测试4: 取消Pin

**操作**: 取消Pin一条消息

**预期日志**:
```
[Pin监控] 检测到取消Pin: om_xxx
[Pin删除] ✅ 已删除Pin归档记录
[Pin统计] ✅ 张三 被Pin次数: 1 -> 0
```

**预期效果**:
- ✅ 归档表中记录被删除
- ✅ 被Pin次数-1
- ✅ **不发送**群内提醒

## 常见问题排查

### 问题1: JSON解析失败

**错误**: `[Pin监控] ❌ JSON解析失败: Expecting value: line 1 column 1 (char 0)`

**原因**: API参数错误或权限不足

**解决**:
- ✅ 已修复: 使用正确的 `chat_id` 参数
- 确认权限 `im:pin:readonly` 已添加

### 问题2: HTTP 403错误

**错误**: `[Pin监控] ❌ HTTP错误: 403`

**原因**: 权限不足

**解决**:
1. 在飞书开放平台添加 `im:pin:readonly` 权限
2. 重新发布应用
3. 确认机器人在群内

### 问题3: 未配置PIN_TABLE_ID

**错误**: `[Pin归档] ⚠️ 未配置PIN_TABLE_ID，跳过归档`

**解决**:
1. 在Bitable创建Pin消息归档表
2. 复制表ID到 `.env` 的 `PIN_TABLE_ID`

### 问题4: 附件上传失败

**错误**: `[Pin附件] ❌ 上传失败`

**原因**: 
- BITABLE_APP_TOKEN配置错误
- 权限不足

**解决**:
1. 确认 `.env` 中 `BITABLE_APP_TOKEN` 正确
2. 确认权限 `bitable:app` 已添加

## 验证清单

测试完成后,确认以下功能正常:

- [ ] Pin监控正常启动,无JSON解析错误
- [ ] 新增Pin时收到群内提醒卡片
- [ ] Pin消息正确归档到Bitable表
- [ ] 时间字段显示为可读文本格式
- [ ] 富文本消息转为纯文本,保留换行
- [ ] 图片/文件附件自动下载上传
- [ ] 被Pin次数统计正确更新
- [ ] 取消Pin时静默删除归档记录
- [ ] 取消Pin时不发送群内提醒

## 性能监控

正常运行时的日志输出:
```
[Pin监控] 当前群内Pin消息数量: 5  # 每30秒输出一次
```

如果长时间没有此日志,说明监控线程可能异常,需要重启程序。
