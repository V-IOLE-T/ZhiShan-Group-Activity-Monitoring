# 关于消息已读监控和表情回复功能的说明

## ❌ 消息已读监控的限制

### 飞书 API 的限制

很遗憾，**飞书开放平台不支持监控群聊中其他用户的消息已读状态**。

飞书提供的 `im.message.message_read_v1` 事件有以下限制：

1. **只能监控机器人自己发送的消息**
2. **只能监控私聊消息**，不支持群聊
3. **无法获取群聊中其他用户的消息已读状态**

### 为什么有这个限制？

这是出于**隐私保护**的考虑：
- 用户的阅读行为属于隐私信息
- 飞书不允许第三方应用追踪用户的阅读行为
- 只有消息发送者（机器人）才能知道自己发送的消息是否被阅读

### 替代方案

如果你想统计用户的活跃度，可以考虑以下替代指标：

1. ✅ **发言次数**（已实现）
2. ✅ **被回复数**（已实现）
3. ✅ **被@次数**（已实现）
4. ✅ **点赞数/被点赞数**（正在实现）
5. 💡 **在线时长**（需要其他方式统计）
6. 💡 **消息响应速度**（可以通过分析回复时间间隔）

## 🔧 表情回复功能调试

### 当前问题

表情回复事件处理函数遇到了属性访问错误。为了调试这个问题，我创建了一个调试脚本。

### 调试步骤

1. **运行调试脚本**：
   ```bash
   python debug_reaction_event.py
   ```

2. **在群里给任意消息添加表情回复**

3. **查看输出**，程序会打印事件对象的所有属性

4. **根据输出调整代码**

### 可能的问题

根据错误信息，可能是以下原因之一：

1. **SDK 版本问题**：不同版本的 `lark_oapi` SDK 可能有不同的属性名
2. **事件结构变化**：飞书可能更新了事件结构
3. **权限问题**：应用可能没有订阅正确的事件

### 检查清单

- [ ] 确认已在飞书开放平台订阅 `im.message.reaction.created_v1` 事件
- [ ] 确认应用有"获取与发送单聊、群组消息"权限
- [ ] 确认 SDK 版本：`pip show lark-oapi`
- [ ] 运行调试脚本查看实际的事件结构

## 📊 当前已实现的功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 消息监听 | ✅ 正常 | 实时监听群聊消息 |
| 发言统计 | ✅ 正常 | 统计发言次数和字数 |
| 回复统计 | ✅ 正常 | 统计被回复数 |
| @统计 | ✅ 正常 | 统计被@次数 |
| 话题统计 | ✅ 正常 | 统计发起话题数 |
| 人员字段 | ✅ 正常 | 关联飞书账号 |
| 表情回复 | ⚠️ 调试中 | 需要调试事件结构 |
| 消息已读 | ❌ 不支持 | 飞书 API 限制 |

## 🎯 下一步行动

### 1. 调试表情回复功能

运行调试脚本找出正确的属性名：
```bash
python debug_reaction_event.py
```

### 2. 如果表情回复功能不可用

可以考虑移除这个功能，专注于已经稳定工作的统计指标：
- 发言次数
- 发言字数
- 被回复数
- 被@次数
- 发起话题数

这些指标已经足够全面地反映用户的活跃度。

### 3. 优化活跃度分数计算

如果不使用点赞统计，可以调整权重：
```python
活跃度分数 = 
    发言次数 × 2.5 +      # 提高权重
    发言字数 × 0.02 +     # 提高权重
    被回复数 × 2.0 +      # 提高权重
    单独被@次数 × 2.0 +   # 提高权重
    发起话题数 × 2.0      # 提高权重
```

## 💡 建议

鉴于飞书 API 的限制，我建议：

1. **先调试表情回复功能**，看是否能正常工作
2. **如果调试困难**，可以暂时移除表情回复功能
3. **专注于已经稳定的功能**，确保核心统计准确
4. **接受 API 限制**，不强求实现消息已读监控

需要我帮你调试表情回复功能，还是移除这个功能专注于已有的统计指标？
